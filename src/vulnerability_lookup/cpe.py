"""Module containing the Common Platform Enumeration."""

from enum import Enum
from typing import Optional

from vulnerability_lookup.cve import CVE, CVESeverity

_INTERNAL_CPE_VERSION = "2.3"


class CPEPart(Enum):
    """Enum representation of a CPE Part definition."""
    APPLICATION = "a"
    HARDWARE = "h"
    OPERATING_SYSTEM = "o"
    ANY = "*"


class CPE:
    """Class representation of a V2.3 Common Platform Enumeration

    A version 2.3 CPE, as defined by NIST shall be in the format:
        cpe:<cpe_version>:<part>:<vendor>:<product>:<version>:<update>:
        <edition>:<language>:<sw_edition>:<target_sw>:<target_hw>:<other>

    For usage with NMAP see:
    https://nmap.org/book/output-formats-cpe.html 
    https://nmap.org/book/osdetect-usage.html
    """

    def __init__(
        self,
        part: CPEPart = CPEPart.ANY,
        vendor: str = "*",
        product: str = "*",
        major_version: str = "*",
        minor_version: Optional[str] = None,
        edition: Optional[str] = None,
        language_tag: Optional[str] = None,
        sw_edition: Optional[str] = None,
        target_sw: Optional[str] = None,
        target_hw: Optional[str] = None
    ):
        """Create a new Common Platform Enumeration object."""
        self.part = part 
        self.vendor = vendor
        self.product = product 
        self.major_version = major_version
        self.minor_version = minor_version or None
        self.edition = edition or None
        self.language_tag = language_tag or None
        self.sw_edition = sw_edition or None
        self.target_sw = target_sw or None
        self.target_hw = target_hw or None

    def find_related_cves(
        self,
        severity: Optional[CVESeverity] = None
    ) -> tuple[CVE]:
        """Find all CVE's related to this CPE object.
        
        Args:
            severity (Optional[CVESeverity]):
                The optional CVE severity level to look for. Only
                CVE's with the matching severity level will be returned.

        Returns:
            tuple[CVE]: A tuple of corresponding CVEs.
        """
        cpe_data = str(self)

    def __str__(self) -> str:
        """CPE string representation."""
        return ":".join(
            filter(None, (
                "cpe",
                _INTERNAL_CPE_VERSION,
                self.part.value,
                self.vendor,
                self.product,
                self.major_version,
                self.minor_version,
                self.edition,
                self.language_tag,
                self.sw_edition,
                self.target_sw,
                self.target_hw
            ))
        )
